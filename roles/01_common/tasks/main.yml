---
# ============================================================
# Role: 01_common
# Mục tiêu: Cập nhật hệ thống, bật cập nhật tự động, cài đặt gói cơ bản và đồng bộ thời gian
# Mapping PCI-DSS: Requirement 6 (Patch Management), 10 (Time sync)
# ============================================================

- name: Update apt cache and upgrade all packages
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
  tags: [common, pci6]
  # Cập nhật danh sách gói và nâng cấp hệ thống lên bản mới nhất (dist-upgrade)

- name: Install base packages
  ansible.builtin.apt:
    name:
      - unattended-upgrades     # Tự động cập nhật bản vá bảo mật
      - apt-listchanges         # Hiển thị thay đổi khi cập nhật
      - cron                    # Hỗ trợ tác vụ định kỳ
      - chrony                  # Đồng bộ thời gian hệ thống
      - vim                     # Trình soạn thảo tiện dụng
      - curl                    # Dụng cụ tải dữ liệu HTTP
      - gnupg                   # Quản lý khóa GPG
      - lsb-release             # Lấy thông tin phiên bản OS
      - ca-certificates         # Chứng chỉ CA gốc
    state: present
    update_cache: yes
  tags: [common, pci6, pci10]

- name: Enable automatic security updates (unattended-upgrades)
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade "1";
    mode: '0644'
  tags: [common, pci6]
  # Cấu hình chu kỳ tự động kiểm tra và cài bản vá bảo mật

- name: Configure unattended-upgrades to only install security updates
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Mail "";
      Unattended-Upgrade::MailOnlyOnError "true";
    mode: '0644'
  tags: [common, pci6]
  # Chỉ bật cập nhật cho nhánh "security" của Ubuntu/Debian

- name: Ensure chrony service is enabled and running
  ansible.builtin.service:
    name: chrony
    state: started
    enabled: yes
  tags: [common, pci10]
  # Bật và khởi động dịch vụ đồng bộ thời gian chrony

- name: Configure chrony to use public NTP pool
  ansible.builtin.lineinfile:
    path: /etc/chrony/chrony.conf
    regexp: '^pool'
    line: 'pool pool.ntp.org iburst'
    insertafter: BOF
  notify: Restart chrony
  tags: [common, pci10]
  # Thay thế cấu hình NTP server mặc định bằng pool.ntp.org

- name: Ensure apt-daily timer is active (systemd)
  ansible.builtin.systemd:
    name: apt-daily.timer
    enabled: yes
    state: started
  tags: [common, pci6]
  # Bật timer của systemd để apt tự động kiểm tra gói cập nhật mỗi ngày

